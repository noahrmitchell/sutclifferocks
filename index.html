<html>
  <head>
    <script type="text/javascript" src="recipes/pizza.js"></script>
    <script type="text/javascript" src="recipes/shortbread.js"></script>
    <script type="text/javascript" src="recipes/curry/currybase.js"></script>
  </head>
  <body>

    <div id="activeRecipe" />
    <script>
      function addName(name) {
        var h1 = document.createElement("h1");
        h1.appendChild(document.createTextNode(name));
        document.getElementById("recipeName").appendChild(h1);
      }

      function addFork(name, url) {
        var p = document.createElement("p");
        var a = document.createElement("a");
        a.appendChild(document.createTextNode(name));
        a.href = url;
        p.appendChild(document.createTextNode("Forked from: "));
        p.appendChild(a);
        document.getElementById("fork").appendChild(p);
      }

      function getIngredientLi(ingredient) {
        var li = document.createElement("li");
        var text = ingredient.name+" ("+ingredient.quantity+ingredient.unit+")";
        if(ingredient.notes) {
          text = text+" - "+ingredient.notes;
        }
        if(ingredient.optional) {
          text = text+" [optional]";
        }
        var textNode = document.createTextNode(text);
        li.appendChild(textNode);
        return li;
      }

      function addIngredient(ingredient) {
        var li = getIngredientLi(ingredient);
        document.getElementById("ingredients").appendChild(li);
      }

      function addStep(step) {
        var li = document.createElement("li");
        var div = document.createElement("div");
        var h5 = document.createElement("h5");
        h5.appendChild(document.createTextNode(step.name));
        div.appendChild(h5);
        var p = document.createTextNode(step.description);
        div.appendChild(p);
        li.appendChild(div);
        document.getElementById("steps").appendChild(li);
      }

      function render(recipe) {
        document.getElementById("activeRecipe").innerHTML='<p id="fork" /><h1 id="recipeName" /><h2>Ingredients</h2><ul id="ingredients"></ul><h2>Steps</h2><ul id="steps"></ul>';
        addName(recipe.name);
        addFork(recipe.forkName, recipe.forkUrl);
        recipe.ingredients.forEach(addIngredient);
        recipe.steps.forEach(addStep);
      }

      function addCondensedStep(step) {
        if(step.ingredients) {
          step.ingredients.forEach(id => document.getElementById("condensedrecipe").appendChild(getIngredientLi(recipe.ingredients.filter(i => i.id === id)[0])));
        }
        var li = document.createElement("li");
        var strong = document.createElement("strong");
        var text = document.createTextNode(step.description);
        strong.appendChild(text);
        li.appendChild(strong);
        document.getElementById("condensedrecipe").appendChild(li);
      }

      function renderCondensed(recipe) {
        document.getElementById("activeRecipe").innerHTML='<ul id="condensedrecipe"/>';
        recipe.steps.forEach(addCondensedStep);
      }

      function getParameterByName(name, url = window.location.href) {
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
          results = regex.exec(url);
          if (!results) return null;
          if (!results[2]) return '';
          return decodeURIComponent(results[2].replace(/\+/g, ' '));
      }

      var recipes = {
        "pizza": pizza,
        "shortbread": shortbread,
        "currybase": currybase
      }
      var r = getParameterByName("recipe");

      var recipe = recipes[r||"pizza"]||pizza;
      if(getParameterByName("view") === "condensed") {
        renderCondensed(recipe);
      } else {
        render(recipe);
      }
    </script>
  </body>
</html>
